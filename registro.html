<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>HERC - UMG</title>
        <link href="css/styles.css" rel="stylesheet" />
        <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    </head>
    <body class="sb-nav-fixed">
        <nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
            <!-- Navbar Brand-->
            <a class="navbar-brand ps-3" href="index.html">HERC - UMG</a>
            <!-- Sidebar Toggle-->
            <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle" href="#!"><i class="fas fa-bars"></i></button>
        </nav>
        <div id="layoutSidenav">
            <div id="layoutSidenav_nav">
                <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
                    <div class="sb-sidenav-menu">
                        <div class="nav">
                            <div class="sb-sidenav-menu-heading">Opciones</div>
                            <a class="nav-link" href="marcaje.html">
                                <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                                Marcajes
                            </a>
                            <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseLayouts" aria-expanded="false" aria-controls="collapseLayouts">
                                <div class="sb-nav-link-icon"><i class="fas fa-columns"></i></div>
                                Usuarios
                                <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                            </a>
                            <div class="collapse" id="collapseLayouts" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                                <nav class="sb-sidenav-menu-nested nav">
                                    <a class="nav-link" href="usuario.html">
                                        <div class="sb-nav-link-icon"><i class="fas fa-user"></i></div>
                                        Usuarios
                                    </a>
                                    <a class="nav-link" href="registro.html">
                                        <div class="sb-nav-link-icon"><i class="fas fa-user"></i></div>
                                        Registrar Usuario
                                    </a>
                                </nav>
                            </div>
                            <!-- <a class="nav-link" href="asueto.html">
                                <div class="sb-nav-link-icon"><i class="fas fa-book-open"></i></div>
                                Asuetos
                            </a> -->
                            <a class="nav-link" href="index.html">
                                <div class="sb-nav-link-icon"><i class="fas fa-bars"></i></div>
                                Salir
                            </a>
                        </div>
                    </div>
                    <div class="sb-sidenav-footer">
                        <div class="small">Desarrollado por:</div>
                        Humberto Rucal <br> 9941-20-3467
                    </div>
                </nav>
            </div>

            <!-- Modal para usuario y contraseña -->
            <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="loginModalLabel">Iniciar Sesión</h5>
                            <a href="marcaje.html">
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </a>
                        </div>
                        <div class="modal-body">
                            <form id="loginForm">
                                <div class="mb-3">
                                    <label for="modalUsername" class="form-label">Usuario</label>
                                    <input type="text" class="form-control" id="modalUsername" required>
                                </div>
                                <div class="mb-3">
                                    <label for="modalPassword" class="form-label">Contraseña</label>
                                    <input type="password" class="form-control" id="modalPassword" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Entrar</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div id="layoutSidenav_content">
                <main id="mainContent" style="display: none;">
                    <div id="layoutAuthentication">
                        <div id="layoutAuthentication_content">
                            <main>
                                <div class="container">
                                    <div class="row justify-content-center">
                                        <div class="col-lg-7">
                                            <div class="card shadow-lg border-0 rounded-lg mt-5">
                                                <div class="card-header"><h3 class="text-center font-weight-light my-4">Registro de usuarios</h3></div>
                                                <div class="card-body">
                                                    <form>
                                                        <div class="row mb-3">
                                                            <label id="lbCodUsuario">Codigo: </label>
                                                        </div>
                                                        <div class="form-floating mb-3">
                                                            <input class="form-control" id="inputName" type="text" placeholder="Ingresa tu usuario" />
                                                            <label for="inputName">Nombre</label>
                                                        </div>
                                                        <div class="row mb-3">
                                                            <div class="col-md-6">
                                                                <div class="form-floating mb-3 mb-md-0">
                                                                    <input class="form-control" id="inputTEntrada" type="time" placeholder="Ingresa horario de entrada" />
                                                                    <label for="inputTEntrada">Horario de Entrada</label>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <div class="form-floating mb-3 mb-md-0">
                                                                    <input class="form-control" id="inputTSalida" type="time" placeholder="Ingresa horario de salida" />
                                                                    <label for="inputTSalida">Horario de Salida</label>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <!-- Elementos para capturar la imagen -->
                                                        <div class="row justify-content-center mt-3">
                                                            <div class="col-lg-6">
                                                                <img id="imgUsuario" style="display: none; max-width: 100%; height: auto;" />
                                                                <video id="video" style="display: none;"></video>
                                                                <canvas id="canvas" style="display: none;"></canvas>
                                                            </div>
                                                        </div>

                                                        <div class="mt-4 mb-0">
                                                            <!-- Botón para registrar usuario -->
                                                            <a class="btn btn-primary" id="btnValidar" style="display: block;"></a>
                                                            <div class="d-flex align-items-center justify-content-between mt-4 mb-0">
                                                                <!-- Botón para actualizar imagen -->
                                                                <a class="btn btn-success" id="btnActualizarImagen" style="display: none;">
                                                                Actualizar Imagen
                                                                </a>
                                                                <span></span>
                                                                <!-- Botón para inactivar usuario -->
                                                                <a class="btn btn-warning" id="btnInactivarUsuario" style="display: none;">
                                                                    Inactivar Usuario
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </main>
                        </div>
                    </div>
                </main>
                <footer class="py-4 bg-light mt-auto">
                    <div class="container-fluid px-4">
                        <div class="d-flex align-items-center justify-content-between small">
                            <div class="text-muted">Copyright &copy; HERC - UMG 2024</div>
                            
                        </div>
                    </div>
                </footer>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
        <script src="js/scripts.js"></script>
    
        <script>

            // Obtener parámetros de la URL
            function obtenerParametroUrl(parametro) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(parametro);
            }

            window.onload = function () {
                const codigoUsuario = obtenerParametroUrl('CodigoUsuario');
                const btnValidar = document.getElementById('btnValidar');
                const btnActualizarImagen = document.getElementById('btnActualizarImagen');
                const btnInactivarUsuario = document.getElementById('btnInactivarUsuario');
                const imgUsuario = document.getElementById('imgUsuario');
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');

                if (codigoUsuario) {
                    // Si hay un parámetro, buscar información del usuario
                    buscarUsuario(codigoUsuario,false);
                } else {
                    // Si no hay parámetros, activar la cámara para captura
                    activarCamara();
                    video.style.display = 'block';
                    video.style.width = '100%';
                    btnValidar.style.display = 'block';
                    btnValidar.textContent = 'Registrar usuario';
                }
            
                // Acción para actualizar imagen y mostrar "Actualizar Usuario"
                btnActualizarImagen.addEventListener('click', () => {
                    activarCamara();
                    video.style.display = 'block';
                    video.style.width = '100%';
                    imgUsuario.style.display = 'none';
                    btnValidar.textContent = 'Actualizar Usuario';
                    btnValidar.style.display = 'block';
                    btnActualizarImagen.style.display = 'none';
                    btnInactivarUsuario.style.display = 'none';
                });
            
                // Mostrar el modal de login si es necesario
                const modal = new bootstrap.Modal(document.getElementById('loginModal'));
                modal.show();
            };

            // Función para buscar usuario en la API
            async function buscarUsuario(codigoUsuario,desactivar) {
                try {
                    if(desactivar){
                        detenerCamara()
                    }
                    const response = await fetch(`http://127.0.0.1:8000/obtener_usuarios/?codigousuario=${codigoUsuario}`);

                    if (!response.ok) {
                        alert('No se encontró el usuario.');
                        window.location.href = 'usuario.html'; // Redirigir si no se encuentra el usuario
                        throw new Error('Error en la respuesta de la API');
                    }
                
                    const data = await response.json();

                    if (data.Usuario && data.Usuario.length > 0) {
                        // Cargar los datos del usuario en los campos correspondientes
                        document.getElementById('lbCodUsuario').textContent = 'Codigo: ' + data.Usuario[0].codigoUsuario;
                        document.getElementById('inputName').value = data.Usuario[0].nombre;
                        document.getElementById('inputTEntrada').value = data.Usuario[0].HoraDeEntrada;
                        document.getElementById('inputTSalida').value = data.Usuario[0].HoraDeSalida;
                        // Cambiar los botones: ocultar registro, mostrar actualizar
                        document.getElementById('btnValidar').style.display = 'none';
                        document.getElementById('btnActualizarImagen').style.display = 'block';
                        document.getElementById('btnInactivarUsuario').style.display = 'block';
                        console.log(data.Usuario[0].activo);
                        console.log(data.Usuario[0].nombre);
                        document.getElementById('btnInactivarUsuario').textContent = (data.Usuario[0].activo == 1 ? 'Inactivar Usuario': 'Activar Usuario');
                        document.getElementById('btnInactivarUsuario').className = (data.Usuario[0].activo == 1 ? 'btn btn-danger' : 'btn btn-warning');
                        mostrarImagenUsuario(data.Usuario[0].Foto);
                        return data.Usuario[0]; // Retorna el primer usuario encontrado
                    } else {
                        alert('No se encontró el usuario.');
                        window.location.href = 'usuario.html'; // Redirigir si no se encuentra el usuario
                        return null; // No encontró el usuario
                    }
                } catch (error) {
                    console.error('Error al buscar usuario:', error);
                    return null; // En caso de error, retorna null
                }
            }

            // Función para mostrar la imagen del usuario en un <img> o canvas
            function mostrarImagenUsuario(imagen) {
                const imgUsuario = document.getElementById('imgUsuario');
                imgUsuario.src = `data:image/jpeg;base64,${imagen}`;
                imgUsuario.style.display = 'block';
                imgUsuario.style.width = '100%';
            }

            // Activar la cámara para capturar imagen
            function activarCamara() {
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
            
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(stream => {
                        video.srcObject = stream;
                        video.play();
                    })
                    .catch(err => console.error('Error al acceder a la cámara:', err));
                
                video.addEventListener('click', () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageData = canvas.toDataURL('image/jpeg');
                    EnviarDatosUsuario(imageData);
                });
            }

            // Función para validar los campos
            function validarFormulario() {
                // Obtener los elementos del formulario
                const usuario = document.getElementById('inputName').value;
                const horarioE = document.getElementById('inputTEntrada').value;
                const horarioS = document.getElementById('inputTSalida').value;

                // Verificar si el campo de usuario está vacío
                if (usuario.trim() === "") {
                    alert("Por favor, ingrese su nombre.");
                    return false;
                }
                
                // Verificar si los horarios están vacíos
                if (horarioE.trim() === "" || horarioS.trim() === "") {
                    alert("Por favor, ingrese ambos horarios de entrada y salida.");
                    return false;
                }
                
                // Validar formato de los horarios (HH:MM, por ejemplo)
                const regexHora = /^([01]\d|2[0-3]):([0-5]\d)$/;
                if (!regexHora.test(horarioE) || !regexHora.test(horarioS)) {
                    alert("Por favor, ingrese los horarios en formato HH:MM.");
                    return false;
                }

                // Validar que el horario de entrada sea antes que el de salida
                if (horarioE >= horarioS) {
                    alert("El horario de entrada debe ser antes que el de salida.");
                    return false;
                }

                // Si todas las validaciones pasan
                return true;
            }

            // Detener la cámara
            function detenerCamara() {
                const video = document.getElementById('video');
                const stream = video.srcObject;
                stream.getTracks().forEach(track => track.stop());
                video.style.display = 'none';
            }
    
            // Capturar foto cuando se presione "Validar marcaje"
            btnValidar.addEventListener('click', () => {
                
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                const context = canvas.getContext('2d');

                // Dibujar el frame del video en el canvas
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
    
                // Obtener la imagen en base64
                const imageData = canvas.toDataURL('image/jpg');
    
                if (validarFormulario()) {
                    // Llamar a la API para enviar la imagen
                    EnviarDatosUsuario(imageData);
                }
                
            });

            // Capturar foto cuando se presione "Validar marcaje"
            btnInactivarUsuario.addEventListener('click', () => {
                EnviarDatosUsuario('');
            });
    
            // Función para enviar la imagen a la API
            function EnviarDatosUsuario(imageData) {
                const usuario = document.getElementById('inputName').value;
                const horarioE = document.getElementById('inputTEntrada').value;
                const horarioS = document.getElementById('inputTSalida').value;
                const btnValidar = document.getElementById('btnValidar').textContent;
                const btnInactivarUsuario = document.getElementById('btnInactivarUsuario').textContent;
                const activo = (btnInactivarUsuario.trim() == "Inactivar Usuario" ? 1: 0);
                const coduser = parseInt(document.getElementById('lbCodUsuario').textContent.replace('Codigo: ',''), 10);
                const base64Image = (imageData.trim() == "" ? imageData.trim(): imageData.split(',')[1]);
                const codigoUsuario = (btnValidar.trim() == "Registrar usuario" ? 0: coduser);
                console.log(codigoUsuario);
                console.log(usuario);
                console.log(horarioE);
                console.log(horarioS);
                console.log(base64Image);
                console.log(activo);
                fetch('http://127.0.0.1:8000/' + (btnValidar.trim() == "Registrar usuario" ? 'registrar_usuario/': 'actualizar_usuario/'), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ codigoUsuario:codigoUsuario ,nombre: usuario, hora_entrada: horarioE, hora_salida: horarioS, imagen_base64: base64Image, activo:activo })
                })
                .then(response => response.json())
                .then(data => {
                // Verificar la respuesta de la API
                alert(data.mensaje);
                if(data.mensaje=='Usuario registrado correctamente' || data.mensaje=='Usuario actualizado correctamente'){
                    buscarUsuario(data.CodigoUsuario, base64Image == "" ? false : true);
                }
                })
                .catch(error => {
                    console.error('Error al enviar la imagen:', error);
                    alert('Hubo un error al registrar el marcaje');
                });
            }

            // Manejo del formulario de inicio de sesión
            document.getElementById('loginForm').addEventListener('submit', function(event) {
                event.preventDefault();

                const username = document.getElementById('modalUsername').value;
                const password = document.getElementById('modalPassword').value;

                // Validar credenciales (puedes ajustar esto)
                if (username === "admin" && password === "admin") {
                    // Si las credenciales son correctas, cerrar el modal y mostrar el contenido principal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
                    modal.hide();
                    document.getElementById('mainContent').style.display = "block"; // Mostrar el formulario
                } else {
                    // Redirigir a otra página si las credenciales son incorrectas
                    window.location.href = "marcaje.html"; // Cambia esto a la URL deseada
                }
            });
        </script>
    </body>
</html>
